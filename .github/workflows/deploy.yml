name: Deploy MCP + APIM with Foundry GPT-4o-mini

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: ai-mcp-rg
  LOCATION: westeurope
  APP_SERVICE_PLAN: mcp-asp
  WEBAPP_NAME: mcp-server-app-davisanc
  APIM_NAME: mcp-apim-davisanc
  APIM_PUBLISHER_EMAIL: test@example.com
  APIM_PUBLISHER_NAME: "David Sanchez"
  AI_PROJECT_NAME: ${{ secrets.AI_PROJECT_NAME || 'davidsr-ai-project-resourcev2' }}
  AI_AGENT_NAME: document-analysis-agent

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # -------------------------------
    # Upgrade Azure CLI to latest version
    # -------------------------------
    - name: Upgrade Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

    # -------------------------------
    # Azure login
    # -------------------------------
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # -------------------------------
    # Create Resource Group
    # -------------------------------
    - name: Create Resource Group
      run: |
        az group create -n $AZURE_RESOURCE_GROUP -l $LOCATION
    #-------------------------------
    # Installing dependencies
    #-------------------------------
    - name: Install npm dependencies
      run: |
        cd mcp-server
        npm install
    

    # -------------------------------
    # Create App Service Plan
    # -------------------------------
    - name: Create App Service Plan
      run: |
        az appservice plan create \
          -g $AZURE_RESOURCE_GROUP \
          -n $APP_SERVICE_PLAN \
          --sku B1 --is-linux

    # -------------------------------
    # Deploy MCP server
    # -------------------------------
    - name: Create Web App for MCP server
      run: |
        az webapp create \
          -g $AZURE_RESOURCE_GROUP \
          -p $APP_SERVICE_PLAN \
          -n $WEBAPP_NAME \
          --runtime "NODE:22-lts"

    - name: Set MCP server App Settings
      run: |
        az webapp config appsettings set \
          -g $AZURE_RESOURCE_GROUP \
          -n $WEBAPP_NAME \
          --settings \
            FOUNDRY_ENDPOINT=${{ secrets.FOUNDRY_ENDPOINT }} \
            FOUNDRY_API_KEY=${{ secrets.FOUNDRY_API_KEY }}

    - name: Deploy MCP Server
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.WEBAPP_NAME }}
        package: ./mcp-server

    # -------------------------------
    # Create APIM and import MCP API
    # -------------------------------
  
    - name: Create APIM
      run: |
        az apim create \
          --resource-group $AZURE_RESOURCE_GROUP \
          --name $APIM_NAME \
          --location $LOCATION \
          --publisher-email $APIM_PUBLISHER_EMAIL \
          --publisher-name "$APIM_PUBLISHER_NAME" \

    


    - name: Import MCP API into APIM
      run: |
        az apim api import \
          -g $AZURE_RESOURCE_GROUP \
          -n $APIM_NAME \
          --path "" \
          --api-id mcp-api \
          --specification-format OpenApi \
          --specification-path ./mcp-server-openapi.yaml \
          --service-url "https://${WEBAPP_NAME}.azurewebsites.net"

    # -------------------------------
    # Use existing Azure AI Foundry Project
    # -------------------------------
    # Note: Assumes you already have an Azure AI Foundry project created
    # The project name should match the AI_PROJECT_NAME environment variable

    # -------------------------------
    # Create/Update Azure AI Agent with MCP
    # -------------------------------
    - name: Install Azure AI Projects SDK
      run: |
        # Install the latest version of azure-ai-projects SDK
        pip install --upgrade azure-ai-projects azure-identity
        pip show azure-ai-projects

    - name: Get Project Connection Details
      id: project_details
      run: |
        # Get the project details to construct the correct endpoint
        PROJECT_JSON=$(az ml workspace show \
          --name $AI_PROJECT_NAME \
          --resource-group $AZURE_RESOURCE_GROUP \
          --output json)
        
        # Extract the discovery URL which contains the AI services endpoint
        DISCOVERY_URL=$(echo $PROJECT_JSON | jq -r '.discovery_url // empty')
        
        # Try to get workspace_id (this might be the AI services account)
        WORKSPACE_ID=$(echo $PROJECT_JSON | jq -r '.workspace_id // empty')
        
        # Extract location
        LOCATION=$(echo $PROJECT_JSON | jq -r '.location // empty')
        
        echo "Discovery URL: $DISCOVERY_URL"
        echo "Workspace ID: $WORKSPACE_ID"
        echo "Location: $LOCATION"
        
        # The correct endpoint format should be:
        # https://<your-ai-services-account>.services.ai.azure.com/api/projects/<ProjectName>
        # We'll try to construct this or use the discovery URL
        
        if [ -n "$DISCOVERY_URL" ]; then
          # Extract the base domain from discovery URL
          BASE_DOMAIN=$(echo $DISCOVERY_URL | sed -E 's|https://([^/]+).*|\1|')
          # Construct the project endpoint
          PROJECT_ENDPOINT="https://${BASE_DOMAIN}/api/projects/${AI_PROJECT_NAME}"
        else
          # Fallback to constructing from location
          PROJECT_ENDPOINT="https://${LOCATION}.api.azureml.ms/api/projects/${AI_PROJECT_NAME}"
        fi
        
        echo "project_endpoint=$PROJECT_ENDPOINT" >> $GITHUB_OUTPUT
        echo "Constructed Project Endpoint: $PROJECT_ENDPOINT"

    - name: Create or Update AI Agent
      env:
        AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        PROJECT_ENDPOINT: ${{ steps.project_details.outputs.project_endpoint }}
      run: |
        python .github/scripts/create_agent.py

    - name: Display Agent Information
      if: success()
      run: |
        echo "================================================"
        echo "üéâ Deployment Complete!"
        echo "================================================"
        echo ""
        echo "üåê Web App: https://${WEBAPP_NAME}.azurewebsites.net"
        echo "üîå MCP Endpoint: https://${WEBAPP_NAME}.azurewebsites.net/mcp/sse"
        echo "ü§ñ AI Agent: ${AI_AGENT_NAME}"
        echo "üìä AI Project: ${AI_PROJECT_NAME}"
        echo ""
        if [ -f agent_id.txt ]; then
          echo "üÜî Agent ID: $(cat agent_id.txt)"
        fi
        echo ""
        echo "Next steps:"
        echo "1. Visit the web app to upload documents"
        echo "2. Use Azure AI Foundry to chat with the agent"
        echo "3. Agent will use MCP to access your documents"
        echo "================================================"
