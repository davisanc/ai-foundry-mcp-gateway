name: Deploy MCP + APIM with Foundry GPT-4o-mini

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: ai-mcp-rg
  AI_PROJECT_RESOURCE_GROUP: ${{ secrets.AI_PROJECT_RESOURCE_GROUP || 'AI-RG' }}
  LOCATION: westeurope
  APP_SERVICE_LOCATION: westeurope
  APP_SERVICE_PLAN: mcp-asp
  WEBAPP_NAME: mcp-server-app-davisanc
  APIM_NAME: mcp-apim-davisanc
  APIM_PUBLISHER_EMAIL: test@example.com
  APIM_PUBLISHER_NAME: "David Sanchez"
  AI_PROJECT_NAME: ${{ secrets.AI_PROJECT_NAME || 'davidsr-ai-project-resourcev2' }}
  AI_AGENT_NAME: document-analysis-agent

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # -------------------------------
    # Upgrade Azure CLI to latest version
    # -------------------------------
    - name: Upgrade Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

    # -------------------------------
    # Azure login
    # -------------------------------
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # -------------------------------
    # Create Resource Group
    # -------------------------------
    - name: Create Resource Group
      run: |
        az group create -n $AZURE_RESOURCE_GROUP -l $LOCATION
    #-------------------------------
    # Installing dependencies
    #-------------------------------
    - name: Install npm dependencies
      run: |
        cd mcp-server
        npm install
    

    # -------------------------------
    # Create App Service Plan
    # -------------------------------
    - name: Create App Service Plan
      run: |
        PLAN_EXISTS=$(az appservice plan show -g $AZURE_RESOURCE_GROUP -n $APP_SERVICE_PLAN --query "id" -o tsv 2>/dev/null)
        if [ -z "$PLAN_EXISTS" ]; then
         echo "Creating App Service Plan..."
            az appservice plan create \
              -g $AZURE_RESOURCE_GROUP \
              -n $APP_SERVICE_PLAN \
 
              --sku B1 --is-linux
 
          else
            echo "App Service Plan already exists, skipping creation"
        fi

    # -------------------------------
    # Deploy MCP server
    # -------------------------------
    - name: Create Web App for MCP server
      run: |
        az webapp create \
          -g $AZURE_RESOURCE_GROUP \
          -p $APP_SERVICE_PLAN \
          -n $WEBAPP_NAME \
          --runtime "NODE:22-lts" || echo "Web app already exists or error occurred"
    # ============================================================================
    # MIGRATION TO MANAGED IDENTITY
    # Enable system-assigned managed identity for secure Azure authentication
    # ============================================================================
    - name: Enable Managed Identity on Web App
      run: |
        az webapp identity assign \
          -g $AZURE_RESOURCE_GROUP \
          -n $WEBAPP_NAME \
          --identities [system]
        
        # Get the Principal ID for role assignment
        PRINCIPAL_ID=$(az webapp identity show \
          -g $AZURE_RESOURCE_GROUP \
          -n $WEBAPP_NAME \
          --query principalId --output tsv)
        
        echo "PRINCIPAL_ID=${PRINCIPAL_ID}" >> $GITHUB_ENV
        echo "‚úÖ Managed Identity enabled. Principal ID: ${PRINCIPAL_ID}"

    - name: Grant Web App Access to AI Foundry
      run: |
        # Get the AI resource ID
        AI_RESOURCE_ID=$(az resource show \
          -g $AI_PROJECT_RESOURCE_GROUP \
          -n $AI_PROJECT_NAME \
          --resource-type "Microsoft.CognitiveServices/accounts" \
          --query id --output tsv)
        
        if [ -z "$AI_RESOURCE_ID" ]; then
          echo "‚ùå Could not find AI resource: $AI_PROJECT_NAME"
          exit 1
        fi
        
        # Assign required roles to the web app's managed identity
        ROLES=("Azure AI User" "Cognitive Services User" "Cognitive Services OpenAI Contributor")
        
        for ROLE in "${ROLES[@]}"; do
          echo "Assigning role: $ROLE"
          az role assignment create \
            --assignee-object-id $PRINCIPAL_ID \
            --assignee-principal-type ServicePrincipal \
            --role "$ROLE" \
            --scope "$AI_RESOURCE_ID" \
            --only-show-errors 2>/dev/null || echo "‚ö†Ô∏è Role may already be assigned"
        done
        
        echo "‚úÖ Web app has access to AI Foundry resource"

    - name: Set MCP server App Settings
      run: |
        az webapp config appsettings set \
          -g $AZURE_RESOURCE_GROUP \
          -n $WEBAPP_NAME \
          --settings \
            FOUNDRY_ENDPOINT=${{ secrets.FOUNDRY_ENDPOINT }}

    - name: Configure App Service for SSE/MCP Support
      run: |
        # Check if app exists and is accessible
        echo "üîç Verifying Web App is ready..."
        READY=false
        for i in {1..10}; do
          if az webapp show -g $AZURE_RESOURCE_GROUP -n $WEBAPP_NAME &>/dev/null; then
            READY=true
            echo "‚úÖ Web App is accessible"
            break
          fi
          echo "‚è≥ Waiting for Web App to be accessible... (attempt $i/10)"
          sleep 5
        done
        
        if [ "$READY" = false ]; then
          echo "‚ùå Web App failed to become accessible"
          exit 1
        fi
        
        # Wait longer before attempting configuration - Azure needs more time to fully sync
        echo "‚è≥ Waiting for App Service backend to be fully ready (60 seconds)..."
        sleep 60
        
        # Retry logic for config set with longer backoff
        MAX_RETRIES=10
        RETRY=0
        
        while [ $RETRY -lt $MAX_RETRIES ]; do
          echo "Attempting to configure App Service (attempt $((RETRY+1))/$MAX_RETRIES)..."
          
          if az webapp config set \
            -g $AZURE_RESOURCE_GROUP \
            -n $WEBAPP_NAME \
            --web-sockets-enabled true \
            --http20-enabled true 2>&1 | tee /tmp/config_output.txt; then
            # Check if the command actually succeeded (not just exit 0)
            if ! grep -q "ERROR\|Conflict" /tmp/config_output.txt; then
              echo "‚úÖ App Service configured successfully"
              exit 0
            fi
          fi
          
          RETRY=$((RETRY+1))
          if [ $RETRY -lt $MAX_RETRIES ]; then
            WAIT_TIME=$((15 + (RETRY * 5)))
            echo "‚ö†Ô∏è Configuration failed, retrying in ${WAIT_TIME} seconds... (attempt $((RETRY+1)) of $MAX_RETRIES)"
            sleep $WAIT_TIME
          fi
        done
        
        echo "‚ùå Failed to configure App Service after $MAX_RETRIES attempts"
        exit 1

    - name: Deploy MCP Server
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.WEBAPP_NAME }}
        package: ./mcp-server

    # -------------------------------
    # Create APIM and import MCP API
    # -------------------------------
  
    - name: Create APIM
      run: |
        az apim create \
          --resource-group $AZURE_RESOURCE_GROUP \
          --name $APIM_NAME \
          --location $LOCATION \
          --sku-name Developer \
          --publisher-email $APIM_PUBLISHER_EMAIL \
          --publisher-name "$APIM_PUBLISHER_NAME"

    - name: Import MCP API into APIM
      run: |
        az apim api import \
          -g $AZURE_RESOURCE_GROUP \
          -n $APIM_NAME \
          --path "/" \
          --api-id mcp-api \
          --specification-format OpenApi \
          --specification-path ./mcp-server-openapi.yaml \
          --service-url "https://${WEBAPP_NAME}.azurewebsites.net"
    
    - name: Configure APIM for Public Access
      run: |
        # Update API to not require subscriptions
        az rest --method PATCH \
          --uri "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/$AZURE_RESOURCE_GROUP/providers/Microsoft.ApiManagement/service/$APIM_NAME/apis/mcp-api?api-version=2023-03-01-preview" \
          --body '{"properties":{"subscriptionRequired":false}}' || true
        
        # Create a public product (no subscription required)
        PRODUCT_RESULT=$(az apim product create \
          -g $AZURE_RESOURCE_GROUP \
          -n $APIM_NAME \
          --product-name "mcp-public" \
          --state published \
          --subscription-required false \
          -o json 2>/dev/null || echo '{}')
        
        PRODUCT_ID=$(echo "$PRODUCT_RESULT" | grep -o '"name":"[^"]*"' | head -1 | cut -d'"' -f4)
        
        if [ -z "$PRODUCT_ID" ]; then
          # If product creation failed, try to find existing public product
          PRODUCTS=$(az apim product list -g $AZURE_RESOURCE_GROUP -n $APIM_NAME -o json)
          PRODUCT_ID=$(echo "$PRODUCTS" | grep -o '"name":"[^"]*"' | grep -v "starter\|unlimited\|hugging" | head -1 | cut -d'"' -f4)
        fi
        
        if [ -n "$PRODUCT_ID" ]; then
          echo "Using product ID: $PRODUCT_ID"
          
          # Update product to not require subscription
          az rest --method PATCH \
            --uri "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/$AZURE_RESOURCE_GROUP/providers/Microsoft.ApiManagement/service/$APIM_NAME/products/$PRODUCT_ID?api-version=2023-03-01-preview" \
            --body '{"properties":{"subscriptionRequired":false}}' || true
          
          # Add API to product
          az apim product api add \
            -g $AZURE_RESOURCE_GROUP \
            -n $APIM_NAME \
            --product-id "$PRODUCT_ID" \
            --api-id mcp-api || true
        fi
        
        echo "‚úÖ APIM configured for public access (no subscription key required)"

    # -------------------------------
    # Use existing Azure AI Foundry Project
    # -------------------------------
    # Note: Assumes you already have an Azure AI Foundry project created
    # The project name should match the AI_PROJECT_NAME environment variable

    # -------------------------------
    # Create/Update Azure AI Agent with MCP
    # -------------------------------
    - name: Install Azure AI Projects SDK
      run: |
        # Install the latest version of azure-ai-projects and azure-ai-agents SDKs
        pip install --upgrade azure-ai-projects azure-ai-agents azure-identity
        pip show azure-ai-projects azure-ai-agents

    - name: Grant Agent Creation Permissions
      continue-on-error: true
      run: |
        bash .github/scripts/grant_permissions.sh

    # - name: Wait for Role Assignment Propagation
    #   run: |
    #     echo "‚è≥ Waiting 60 seconds for Azure role assignments to propagate..."
    #     sleep 60
    #     echo "‚úÖ Role assignment propagation wait complete"

    - name: Get Project Connection Details
      id: project_details
      run: |
        bash .github/scripts/get_project_endpoint.sh

    - name: Create or Update AI Agent
      env:
        AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        PROJECT_ENDPOINT: ${{ steps.project_details.outputs.project_endpoint }}
      run: |
        python .github/scripts/create_agent.py

    - name: Display Agent Information
      if: success()
      run: |
        echo "================================================"
        echo "üéâ Deployment Complete!"
        echo "================================================"
        echo ""
        echo "üåê Web App: https://${WEBAPP_NAME}.azurewebsites.net"
        echo "üîå MCP Endpoint: https://${WEBAPP_NAME}.azurewebsites.net/mcp/sse"
        echo "üîó APIM Gateway: https://${APIM_NAME}.azure-api.net"
        echo "ü§ñ AI Agent: ${AI_AGENT_NAME}"
        echo "üìä AI Project: ${AI_PROJECT_NAME}"
        echo ""
        if [ -f agent_id.txt ]; then
          echo "üÜî Agent ID: $(cat agent_id.txt)"
        fi
        echo ""
        echo "üìù APIM API Endpoints (no subscription key required):"
        echo "  GET  https://${APIM_NAME}.azure-api.net/"
        echo "  GET  https://${APIM_NAME}.azure-api.net/healthz"
        echo "  POST https://${APIM_NAME}.azure-api.net/session"
        echo "  POST https://${APIM_NAME}.azure-api.net/session/{sid}/upload"
        echo "  GET  https://${APIM_NAME}.azure-api.net/mcp/sse"
        echo ""
        echo "Next steps:"
        echo "1. Visit the web app to upload documents"
        echo "2. Use Azure AI Foundry to chat with the agent"
        echo "3. Agent will use MCP to access your documents"
        echo "================================================"
