name: Deploy MCP + APIM with Foundry GPT-4o-mini

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: ai-mcp-rg
  LOCATION: westeurope
  APP_SERVICE_PLAN: mcp-asp
  WEBAPP_NAME: mcp-server-app-davisanc
  APIM_NAME: mcp-apim-davisanc
  APIM_PUBLISHER_EMAIL: test@example.com
  APIM_PUBLISHER_NAME: "David Sanchez"
  AI_PROJECT_NAME: ${{ secrets.AI_PROJECT_NAME || 'davidsr-ai-project-resourcev2' }}
  AI_AGENT_NAME: document-analysis-agent

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # -------------------------------
    # Upgrade Azure CLI to latest version
    # -------------------------------
    - name: Upgrade Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

    # -------------------------------
    # Azure login
    # -------------------------------
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # -------------------------------
    # Create Resource Group
    # -------------------------------
    - name: Create Resource Group
      run: |
        az group create -n $AZURE_RESOURCE_GROUP -l $LOCATION
    #-------------------------------
    # Installing dependencies
    #-------------------------------
    - name: Install npm dependencies
      run: |
        cd mcp-server
        npm install
    

    # -------------------------------
    # Create App Service Plan
    # -------------------------------
    - name: Create App Service Plan
      run: |
        az appservice plan create \
          -g $AZURE_RESOURCE_GROUP \
          -n $APP_SERVICE_PLAN \
          --sku B1 --is-linux

    # -------------------------------
    # Deploy MCP server
    # -------------------------------
    - name: Create Web App for MCP server
      run: |
        az webapp create \
          -g $AZURE_RESOURCE_GROUP \
          -p $APP_SERVICE_PLAN \
          -n $WEBAPP_NAME \
          --runtime "NODE:22-lts"

    - name: Set MCP server App Settings
      run: |
        az webapp config appsettings set \
          -g $AZURE_RESOURCE_GROUP \
          -n $WEBAPP_NAME \
          --settings \
            FOUNDRY_ENDPOINT=${{ secrets.FOUNDRY_ENDPOINT }} \
            FOUNDRY_API_KEY=${{ secrets.FOUNDRY_API_KEY }}

    - name: Deploy MCP Server
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.WEBAPP_NAME }}
        package: ./mcp-server

    # -------------------------------
    # Create APIM and import MCP API
    # -------------------------------
  
    - name: Create APIM
      run: |
        az apim create \
          --resource-group $AZURE_RESOURCE_GROUP \
          --name $APIM_NAME \
          --location $LOCATION \
          --publisher-email $APIM_PUBLISHER_EMAIL \
          --publisher-name "$APIM_PUBLISHER_NAME" \

    


    - name: Import MCP API into APIM
      run: |
        az apim api import \
          -g $AZURE_RESOURCE_GROUP \
          -n $APIM_NAME \
          --path "" \
          --api-id mcp-api \
          --specification-format OpenApi \
          --specification-path ./mcp-server-openapi.yaml \
          --service-url "https://${WEBAPP_NAME}.azurewebsites.net"

    # -------------------------------
    # Use existing Azure AI Foundry Project
    # -------------------------------
    # Note: Assumes you already have an Azure AI Foundry project created
    # The project name should match the AI_PROJECT_NAME environment variable

    # -------------------------------
    # Create/Update Azure AI Agent with MCP
    # -------------------------------
    - name: Install Azure AI Projects SDK
      run: |
        pip install azure-ai-projects azure-identity

    - name: Prepare Agent Configuration
      env:
        AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      run: |
        python - <<'EOF'
        import os
        
        # MCP server URL
        mcp_url = f"https://{os.environ['WEBAPP_NAME']}.azurewebsites.net/mcp/sse"
        
        print(f"")
        print(f"‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
        print(f"‚ïë  üöÄ MCP Server Deployed Successfully!                         ‚ïë")
        print(f"‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")
        print(f"")
        print(f"üìç MCP Endpoint: {mcp_url}")
        print(f"")
        print(f"‚ö†Ô∏è  Note: Automated AI Agent creation is not supported via Python SDK yet.")
        print(f"   Please create the agent manually in Azure AI Foundry portal.")
        print(f"")
        print(f"‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
        print(f"‚ïë  üìñ Manual Agent Creation Steps                               ‚ïë")
        print(f"‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")
        print(f"")
        print(f"1. Go to Azure AI Foundry: https://ai.azure.com")
        print(f"")
        print(f"2. Navigate to your project:")
        print(f"   Project Name: {os.environ['AI_PROJECT_NAME']}")
        print(f"   Resource Group: {os.environ['AZURE_RESOURCE_GROUP']}")
        print(f"")
        print(f"3. Create a new Agent with these settings:")
        print(f"   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê")
        print(f"   ‚îÇ Name: {os.environ['AI_AGENT_NAME']:<44} ‚îÇ")
        print(f"   ‚îÇ Model: gpt-4o-mini                                      ‚îÇ")
        print(f"   ‚îÇ Description: AI agent for document analysis via MCP     ‚îÇ")
        print(f"   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò")
        print(f"")
        print(f"4. Add MCP Connection:")
        print(f"   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê")
        print(f"   ‚îÇ Type: Model Context Protocol (MCP)                     ‚îÇ")
        print(f"   ‚îÇ Transport: Server-Sent Events (SSE)                    ‚îÇ")
        print(f"   ‚îÇ URL: {mcp_url:<48} ‚îÇ")
        print(f"   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò")
        print(f"")
        print(f"5. Set Agent Instructions:")
        print(f"   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê")
        print(f"   ‚îÇ You are a helpful document analysis assistant with     ‚îÇ")
        print(f"   ‚îÇ access to uploaded documents via MCP tools.            ‚îÇ")
        print(f"   ‚îÇ                                                         ‚îÇ")
        print(f"   ‚îÇ When users ask about documents:                        ‚îÇ")
        print(f"   ‚îÇ 1. Use list_documents to see available documents       ‚îÇ")
        print(f"   ‚îÇ 2. Use get_document to retrieve specific content       ‚îÇ")
        print(f"   ‚îÇ 3. Use search_documents to find information            ‚îÇ")
        print(f"   ‚îÇ 4. Provide clear, accurate answers                     ‚îÇ")
        print(f"   ‚îÇ                                                         ‚îÇ")
        print(f"   ‚îÇ Always cite which document you're referencing.         ‚îÇ")
        print(f"   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò")
        print(f"")
        print(f"6. Test the Agent:")
        print(f"   - Upload a document at: https://{os.environ['WEBAPP_NAME']}.azurewebsites.net")
        print(f"   - Note the session ID from the upload response")
        print(f"   - In the agent chat, ask: 'List documents in session <session-id>'")
        print(f"")
        print(f"‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")
        print(f"")
        
        EOF

    - name: Display Agent Information
      if: success()
      run: |
        echo "================================================"
        echo "üéâ Deployment Complete!"
        echo "================================================"
        echo ""
        echo "üåê Web App: https://${WEBAPP_NAME}.azurewebsites.net"
        echo "üîå MCP Endpoint: https://${WEBAPP_NAME}.azurewebsites.net/mcp/sse"
        echo "ü§ñ AI Agent: ${AI_AGENT_NAME}"
        echo "üìä AI Project: ${AI_PROJECT_NAME}"
        echo ""
        if [ -f agent_id.txt ]; then
          echo "üÜî Agent ID: $(cat agent_id.txt)"
        fi
        echo ""
        echo "Next steps:"
        echo "1. Visit the web app to upload documents"
        echo "2. Use Azure AI Foundry to chat with the agent"
        echo "3. Agent will use MCP to access your documents"
        echo "================================================"
