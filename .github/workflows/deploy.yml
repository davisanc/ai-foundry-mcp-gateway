name: Deploy MCP + APIM with Foundry GPT-4o-mini

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: ai-mcp-rg
  LOCATION: westeurope
  APP_SERVICE_PLAN: mcp-asp
  WEBAPP_NAME: mcp-server-app-davisanc
  APIM_NAME: mcp-apim-davisanc
  APIM_PUBLISHER_EMAIL: test@example.com
  APIM_PUBLISHER_NAME: "David Sanchez"
  AI_PROJECT_NAME: ai-foundry-mcp-project
  AI_AGENT_NAME: document-analysis-agent

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # -------------------------------
    # Upgrade Azure CLI to latest version
    # -------------------------------
    - name: Upgrade Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

    # -------------------------------
    # Azure login
    # -------------------------------
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # -------------------------------
    # Create Resource Group
    # -------------------------------
    - name: Create Resource Group
      run: |
        az group create -n $AZURE_RESOURCE_GROUP -l $LOCATION
    #-------------------------------
    # Installing dependencies
    #-------------------------------
    - name: Install npm dependencies
      run: |
        cd mcp-server
        npm install
    

    # -------------------------------
    # Create App Service Plan
    # -------------------------------
    - name: Create App Service Plan
      run: |
        az appservice plan create \
          -g $AZURE_RESOURCE_GROUP \
          -n $APP_SERVICE_PLAN \
          --sku B1 --is-linux

    # -------------------------------
    # Deploy MCP server
    # -------------------------------
    - name: Create Web App for MCP server
      run: |
        az webapp create \
          -g $AZURE_RESOURCE_GROUP \
          -p $APP_SERVICE_PLAN \
          -n $WEBAPP_NAME \
          --runtime "NODE:22-lts"

    - name: Set MCP server App Settings
      run: |
        az webapp config appsettings set \
          -g $AZURE_RESOURCE_GROUP \
          -n $WEBAPP_NAME \
          --settings \
            FOUNDRY_ENDPOINT=${{ secrets.FOUNDRY_ENDPOINT }} \
            FOUNDRY_API_KEY=${{ secrets.FOUNDRY_API_KEY }}

    - name: Deploy MCP Server
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.WEBAPP_NAME }}
        package: ./mcp-server

    # -------------------------------
    # Create APIM and import MCP API
    # -------------------------------
  
    - name: Create APIM
      run: |
        az apim create \
          --resource-group $AZURE_RESOURCE_GROUP \
          --name $APIM_NAME \
          --location $LOCATION \
          --publisher-email $APIM_PUBLISHER_EMAIL \
          --publisher-name "$APIM_PUBLISHER_NAME" \

    


    - name: Import MCP API into APIM
      run: |
        az apim api import \
          -g $AZURE_RESOURCE_GROUP \
          -n $APIM_NAME \
          --path "" \
          --api-id mcp-api \
          --specification-format OpenApi \
          --specification-path ./mcp-server-openapi.yaml \
          --service-url "https://${WEBAPP_NAME}.azurewebsites.net"

    # -------------------------------
    # Create Azure AI Foundry Project (if not exists)
    # -------------------------------
    - name: Check if AI Foundry Project exists
      id: check_project
      run: |
        if az ml workspace show --name $AI_PROJECT_NAME --resource-group $AZURE_RESOURCE_GROUP 2>/dev/null; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true

    - name: Create AI Foundry Project
      if: steps.check_project.outputs.exists == 'false'
      run: |
        az ml workspace create \
          --name $AI_PROJECT_NAME \
          --resource-group $AZURE_RESOURCE_GROUP \
          --location $LOCATION \
          --kind project
      continue-on-error: true

    # -------------------------------
    # Create/Update Azure AI Agent with MCP
    # -------------------------------
    - name: Install Azure AI Projects SDK
      run: |
        pip install azure-ai-projects azure-identity

    - name: Create or Update AI Agent
      env:
        AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      run: |
        python - <<'EOF'
        import os
        from azure.ai.projects import AIProjectClient
        from azure.identity import DefaultAzureCredential
        
        # Initialize client
        credential = DefaultAzureCredential()
        client = AIProjectClient(
            credential=credential,
            subscription_id=os.environ['AZURE_SUBSCRIPTION_ID'],
            resource_group_name=os.environ['AZURE_RESOURCE_GROUP'],
            project_name=os.environ['AI_PROJECT_NAME']
        )
        
        # MCP server URL
        mcp_url = f"https://{os.environ['WEBAPP_NAME']}.azurewebsites.net/mcp/sse"
        
        # Agent configuration
        agent_config = {
            "model": "gpt-4o-mini",
            "name": os.environ['AI_AGENT_NAME'],
            "description": "AI agent that analyzes documents using MCP gateway",
            "instructions": """You are a helpful document analysis assistant with access to uploaded documents via MCP tools.
        
        When users ask about documents:
        1. Use list_documents to see available documents in their session
        2. Use get_document to retrieve specific document content
        3. Use search_documents to find information across documents
        4. Provide clear, accurate answers based on the document content
        
        Always cite which document you're referencing in your answers.
        Be helpful, professional, and thorough in your analysis.""",
            "tools": [
                {
                    "type": "mcp",
                    "mcp": {
                        "url": mcp_url,
                        "transport": "sse"
                    }
                }
            ]
        }
        
        try:
            # Try to create the agent
            agent = client.agents.create_agent(**agent_config)
            print(f"âœ… Agent created successfully!")
            print(f"   Agent ID: {agent.id}")
            print(f"   Agent Name: {agent.name}")
            print(f"   MCP URL: {mcp_url}")
            
            # Save agent ID for later use
            with open('agent_id.txt', 'w') as f:
                f.write(agent.id)
                
        except Exception as e:
            print(f"âš ï¸  Error creating agent: {e}")
            print(f"   This may be normal if the agent already exists.")
            print(f"   MCP server is still available at: {mcp_url}")
        
        EOF

    - name: Display Agent Information
      if: success()
      run: |
        echo "================================================"
        echo "ðŸŽ‰ Deployment Complete!"
        echo "================================================"
        echo ""
        echo "ðŸŒ Web App: https://${WEBAPP_NAME}.azurewebsites.net"
        echo "ðŸ”Œ MCP Endpoint: https://${WEBAPP_NAME}.azurewebsites.net/mcp/sse"
        echo "ðŸ¤– AI Agent: ${AI_AGENT_NAME}"
        echo "ðŸ“Š AI Project: ${AI_PROJECT_NAME}"
        echo ""
        if [ -f agent_id.txt ]; then
          echo "ðŸ†” Agent ID: $(cat agent_id.txt)"
        fi
        echo ""
        echo "Next steps:"
        echo "1. Visit the web app to upload documents"
        echo "2. Use Azure AI Foundry to chat with the agent"
        echo "3. Agent will use MCP to access your documents"
        echo "================================================"
